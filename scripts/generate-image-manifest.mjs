
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const publicDir = path.resolve(__dirname, '../public/img');
const outputDir = path.resolve(__dirname, '../src/data');
const outputFile = path.join(outputDir, 'imageManifest.ts');

function getImagesInDir(dirPath) {
    if (!fs.existsSync(dirPath)) return [];
    return fs.readdirSync(dirPath)
        .filter(file => /\.(jpg|jpeg|png|webp)$/i.test(file))
        .sort((a, b) => a.localeCompare(b, undefined, { numeric: true, sensitivity: 'base' }))
        .map(file => path.basename(file));
}

function generateManifest() {
    const projectImages = {};
    const driveImages = [];

    // Scan project folders 1..8
    for (let i = 1; i <= 8; i++) {
        const id = i.toString();
        const dir = path.join(publicDir, id);
        const images = getImagesInDir(dir);
        if (images.length > 0) {
            projectImages[id] = images.map(img => `/img/${id}/${img}`);
        }
    }

    // Scan drive folder
    const driveDir = path.join(publicDir, 'drive');
    const dImages = getImagesInDir(driveDir);
    if (dImages.length > 0) {
        driveImages.push(...dImages.map(img => `/img/drive/${img}`));
    }

    const content = `// Generated by scripts/generate-image-manifest.mjs
export const imageManifest = {
    projectImages: ${JSON.stringify(projectImages, null, 4)} as Record<string, string[]>,
    driveImages: ${JSON.stringify(driveImages, null, 4)} as string[]
};
`;

    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
    }

    fs.writeFileSync(outputFile, content);
    console.log(`Manifest generated at ${outputFile}`);
}

generateManifest();
