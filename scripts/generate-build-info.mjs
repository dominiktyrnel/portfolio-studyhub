import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const packageJsonPath = path.join(__dirname, '../package.json');
const outputPath = path.join(__dirname, '../src/admin/buildInfo.ts');

try {
    const pkg = JSON.parse(fs.readFileSync(packageJsonPath, 'utf8'));

    // Ensure admin dir exists
    const adminDir = path.dirname(outputPath);
    if (!fs.existsSync(adminDir)) {
        fs.mkdirSync(adminDir, { recursive: true });
    }

    const buildInfo = {
        version: pkg.version,
        buildTime: new Date().toISOString(),
        dependencies: {
            ...pkg.dependencies,
            ...pkg.devDependencies
        }
    };

    const content = `// Auto-generated by scripts/generate-build-info.mjs
export const buildInfo = ${JSON.stringify(buildInfo, null, 4)};
`;

    fs.writeFileSync(outputPath, content);
    console.log('Build info generated at src/admin/buildInfo.ts');

} catch (error) {
    console.error('Error generating build info:', error);
    process.exit(1);
}
