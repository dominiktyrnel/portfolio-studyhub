rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // HELPER FUNCTIONS
    // ==========================================
    
    // Check if user is admin
    function isAdmin() {
      return request.auth != null 
        && exists(/databases/$(database)/documents/admins/$(request.auth.uid))
        && get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Check if user is owner of the document
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // ==========================================
    // ADMIN COLLECTION
    // ==========================================
    
    // Admins collection - read-only (managed manually in Firebase Console)
    match /admins/{adminId} {
      // Only authenticated users can check if THEY are admin (own UID)
      // This prevents enumeration of admin UIDs by attackers
      allow read: if request.auth != null && request.auth.uid == adminId;
      allow write: if false; // Must be set manually in console
    }
    
    // ==========================================
    // STUDY CONTENT (PUBLIC READ, ADMIN WRITE)
    // ==========================================
    
    // Study Plan - single document
    match /study_plan/current {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Admin only
    }
    
    // Room Settings - single document
    match /room_settings/current {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Admin only
    }
    
    // FAQ Items collection
    match /faq_items/{faqId} {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Admin only
    }
    
    // Study Global Settings - single document
    match /study_global_settings/current {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Admin only
    }
    
    // Study Schedule - weekly schedule document
    match /study_schedule/current {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Admin only
    }
    
    // ==========================================
    // BOT STATUS & EVENTS (PUBLIC READ, SERVER WRITE)
    // ==========================================
    
    // Bot Status - written by server only
    match /bot_status/current {
      allow read: if true; // Public read for dashboard
      allow write: if false; // Server-side only (via Admin SDK)
    }
    
    // Bot Heartbeat - separate from current per BOT_Definice.md
    // Admin/debug only - public dashboard should NOT listen to this
    match /bot_status/heartbeat {
      allow read: if isAdmin(); // Admin only (to avoid triggering reads)
      allow write: if false; // Server-side only (via Admin SDK)
    }
    
    // Stream Stats - written by server only
    match /stream_stats/current {
      allow read: if true; // Public read
      allow write: if false; // Server-side only
    }
    
    // Events collection - written by server only
    match /events/{eventId} {
      allow read: if true; // Public read for timeline
      allow write: if false; // Server-side only
    }
    
    // Daily Stats collection - written by server only
    match /daily_stats/{dayKey} {
      allow read: if true; // Public read for records
      allow write: if isAdmin(); // Admin can import, server can write via Admin SDK
    }
    
    // Study Sessions collection - written by server only
    match /study_sessions/{sessionId} {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Admin can import, server can write via Admin SDK
    }
    
    // Active Sessions collection - temporary backup for Cloud Run multi-instance
    // Bot uses Admin SDK so this is just documentation
    match /active_sessions/{channelId} {
      allow read: if false; // Bot only (Admin SDK)
      allow write: if false; // Bot only (Admin SDK)
    }
    
    // ==========================================
    // RUNTIME DATA (OBS SYNC, ADMIN COMMANDS)
    // ==========================================
    
    // OBS Pomodoro timer data - written by OBS Python script with API key
    match /runtime/obsPomodoro {
      allow read: if true; // Public read for dashboard
      allow write: if true; // Allow OBS script to write (uses API key auth)
    }
    
    // Admin command buffer - for admin console commands
    match /runtime/adminCommand {
      allow read: if true; // Bot reads this
      allow write: if isAdmin(); // Only admin can send commands
    }
    
    // Bot commands collection - custom chat commands
    match /bot_commands/{commandId} {
      allow read: if isAdmin(); // Admin only
      allow write: if isAdmin(); // Admin only
    }
    
    // ==========================================
    // USER PROFILES (STUDY HUB)
    // ==========================================
    
    // User profiles - users can only read/write their own profile
    match /study_users/{userId} {
      // Anyone can read public profile data
      allow read: if true;
      
      // Only the user can create their own profile (during registration)
      allow create: if isAuthenticated() 
        && request.auth.uid == userId
        && request.resource.data.uid == userId
        && request.resource.data.schemaVersion == 1;
      
      // Only the user can update their own profile
      allow update: if isOwner(userId);
      
      // Only admin can delete profiles
      allow delete: if isAdmin();
    }
    
    // Handle reservations for uniqueness
    match /study_handles/{handle} {
      // Anyone can check if a handle exists (for validation)
      allow read: if true;
      
      // Only authenticated users can create (during registration)
      // The handle doc must match the user's UID
      allow create: if isAuthenticated() 
        && request.resource.data.uid == request.auth.uid;
      
      // No updates allowed - handles are permanent
      allow update: if false;
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // BOT CONFIG (ADMIN ONLY)
    // ==========================================
    
    match /config/bot {
      allow read: if isAdmin(); // Admin only
      allow write: if isAdmin(); // Admin only
    }
    
    // ==========================================
    // INBOX QUESTIONS (AUTH REQUIRED)
    // ==========================================
    
    match /inbox_questions/{questionId} {
      // Anyone authenticated can create their own question
      allow create: if isAuthenticated() 
        && request.resource.data.userId == request.auth.uid
        && request.resource.data.schemaVersion == 1;
      
      // User can read their own questions, admin can read all
      allow read: if isOwner(resource.data.userId) || isAdmin();
      
      // Only admin can update (for answering, status changes)
      allow update: if isAdmin();
      
      // Only admin can delete
      allow delete: if isAdmin();
    }
    
    // ==========================================
    // CONTENT COLLECTIONS (ADMIN EDITABLE)
    // ==========================================
    
    // Content collections for different languages
    // Used by admin editors (ProfileEditor, HomeEditor, GlobalEditor)
    match /content/{lang} {
      allow read: if true; // Public read for all languages
      allow write: if isAdmin(); // Admin only write
    }
    
    // Settings collection (for dataVersion tracking)
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Projects collection (Portfolio items - admin editable)
    // Used by admin portfolio editor
    match /projects/{projectId} {
      allow read: if true; // Public read for portfolio display
      allow write: if isAdmin(); // Admin only write
      allow delete: if isAdmin(); // Admin only delete
    }
    
    // ==========================================
    // CV CONTENT (ADMIN ONLY)
    // ==========================================
    
    // Global settings
    match /global/content {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Admin only
    }
    
    // Home page content
    match /home/content {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Admin only
    }
    
    // Profile content
    match /profile/content {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Admin only
    }
    
    // Portfolio items
    match /portfolio/{itemId} {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Admin only
    }
    
    // Documents
    match /documents/{docId} {
      allow read: if true; // Public read
      allow write: if isAdmin(); // Admin only
    }
    
    // ==========================================
    // LEGACY COLLECTIONS (TEMPORARY)
    // ==========================================
    
    // Old messages collection (deprecated, will be migrated to inbox_questions)
    match /messages/{messageId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Old study_plan collection items (deprecated, use study_plan/current)
    match /study_plan/{itemId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // ==========================================
    // DEFAULT DENY ALL
    // ==========================================
    
    // Deny all other paths by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
